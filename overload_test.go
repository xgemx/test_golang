package main

import (
	"bufio"
	"encoding/json"
	"fmt"
	"io/ioutil"
	"net"
	"net/http"
	// "sort"
	"math/rand"
	"testing"
	"time"
)

func TestOverload(t *testing.T) {
	finishTestsCount := make(chan int)
	type testSet struct {
		numOfTests  int
		oneIter     int
		resultCount int
		runTime     int
		tests       []string
	}
	tests := []string{
		"Go Coding Test We would like you to build a simple Go application. When started, it will listen on port 5555 (but this may be configurable through a command-line flag). Clients will be able to connect to this port and send arbitrary natural language over the wire. The purpose of the application is to process the text, and store some stats about the different words that it sees. The application will also expose an HTTP interface on port 8080 (configurable): clients hitting the /stats endpoint with an optional query string variable N will receive a JSON representation of the statistics about the words that the application has seen so far. Specifically, the JSON response for /stats should look like: ```javascript { \"count\": 42, \"top_5_words\": [\"lorem\", \"ipsum\", \"dolor\", \"sit\", \"amet\"], \"top_5_letters\": [\"e\", \"t\", \"a\", \"o\", \"i\"] } ``` Where `count` represents the total number of words seen, `top_5_words` contains the 5 words that have been seen with the highest frequency, and `top_5_letters` contains the 5 letters that have been seen with the highest frequency (you may choose to transform all letters to lowercase if you so wish). If N is provided, then its value should be used instead: ```javascript // /stats?N=3 { \"count\": 42, \"top_3_words\": [\"lorem\", \"ipsum\", \"dolor\"], \"top_3_letters\": [\"e\", \"t\", \"a\"] } ``` ## Things to look out for * The number of words to process may be large, although you may safely assume that they will fit within main memory. * The application should support a high degree of concurrency, whereby many clients would be sending text at the same time. * We would like to see your approach to automated testing for this type of Go program.",
		"Nice",
		"The application will also expose an HTTP interface on port 8080 (configurable): clients hitting the /stats endpoint with an optional query string variable N will receive a JSON representation of the statistics about the words that the application has seen so far.",
		"About Housing Anywhere What is HousingAnywhere.com? HousingAnywhere.com is a startup founded by a group of students from the Rotterdam School of Management. It provides a housing platform where you can sublet your room to incoming exchange students when you go abroad on an exchange or internship. HousingAnywhere is a platform where the demand and supply of short term accommodation can come together. It is a simple yet effective tool which increases the amount of short term accommodation available to incoming exchange students. How did HousingAnywhere.com start? HousingAnywhere was founded by students from the RSM Erasmus University in Rotterdam, the Netherlands in 2009. These students had problems subletting their rooms in Rotterdam when they wanted to go on an exchange semester to Singapore: none of the local Dutch students were interested in renting a room for just 4 months. At the same time, they heard from the International Office of the University that a lot of incoming international students had problems finding short-stay accommodation in Rotterdam. That is why they decided to set up a platform for short-term housing. HousingAnywhere in numbers In 2009 Housing Anywhere started as a student project at the Erasmus University, but by 2010, the platform expanded to most other universities in the Netherlands who saw this platform as a welcome addition to the current housing solutions they offered. In 2011, HousingAnywhere.com started to expand internationally: Spain, France, Germany and Denmark were added to the website. Since then the platform has continued to grow. Currently 72 universities worldwide offer this platform as one of the housing solutions to their international students. In the past 5 years, over 5000 rooms have been offered from local students to international students on this platform. In addition, over the past 5 years, 0 scams or problems have been reported. This great success is thanks to the student-to-student concept of the platform. What HousingAnywhere is not: HousingAnywhere is not a real-estate company: it does not own houses. It is purely a platform where students can rent out their rooms to other students while they are overseas on an internship or exchange semester. HousingAnywhere is not a substitute for your current housing systems or dormitories, but should be seen as an additional housing service that universities can offer to their incoming exchange students, besides the current facilities. HousingAnywhere should not be seen as a threat for the jobs of the staff at the housing office: HousingAnywhere will not replace the Housing Office. Although, in this day and age, most students like to arrange everything themselves on the internet (“the Ebay Generation”) there will always be a group of students that prefers the personalized service of the Housing Office. When HousingAnywhere can benefit “the Ebay Generation” by giving an online solution, the Housing Office will have more time to successfully serve the other group of students. Joining and questions Joining HousingAnywhere can be done easily by contacting Niels van Deuren at niels@housinganywhere.com. You will receive sample emails which you can send to your exchange students and sample text that you can add on your university website. Next to that, we will hire a local student as “Ambassador” who will do a promotion campaign at your university campus to spread the word of HousingAnywhere locally. Download brochure For more information, you can download our brochure. Click here to download it. After downloading, you can send the brochure to your colleagues at the university to inform them about the existence of this platform. Below are testimonials of happy users of HousingAnywhere.com from around the world!",
		"Back-End Developer | Head Office Rotterdam | full time Rotterdam, Netherlands · IT Development · asap DESCRIPTION Your Responsibilities We already serve 1+ million visitors per year, from all over the world, but we are scaling our platform towards a website that is able to serve many more people and room listings. Next to that, all these rooms need to be booked through a payment/transaction system. Currently, the website is built using Go (Golang) backed by a Postgres database and a simple payment/transaction system. The server components are hosted on a ‘cloud’ architecture that allows easy scaling. Our tech team currently consists of two people, both ‘full-stack’ developers. We are looking to expand this team with a talented developer who has proven work experience writing Go code or extensive experience in alternative languages (e.g. C, Python, Java) and who is eager to learn Go. You will solve complex challenges with the development team and the founding team! Sounds challenging? Be part of building our startup!",
		"This is a short string",
		"Back-End Developer | Head Office Rotterdam | full time Rotterdam, Netherlands · IT Development · asap DESCRIPTION Your Responsibilities We already serve 1+ million visitors per year, from all over the world, but we are scaling our platform towards a website that is able to serve many more people and room listings. Next to that, all these rooms need to be booked through a payment/transaction system. Currently, the website is built using Go (Golang) backed by a Postgres database and a simple payment/transaction system. The server components are hosted on a ‘cloud’ architecture that allows easy scaling. Our tech team currently consists of two people, both ‘full-stack’ developers. We are looking to expand this team with a talented developer who has proven work experience writing Go code or extensive experience in alternative languages (e.g. C, Python, Java) and who is eager to learn Go. You will solve complex challenges with the development team and the founding team! Sounds challenging? Be part of building our startup! REQUIREMENTS Characteristics we are looking for in Back end Developer: Passionate coder Independent Structured and organized Experience needed: An educational background in the field of Information Technology or similar is preferable, although passionate career changers are also welcome. Experience with online marketplaces, service providers and API development Database knowledge on queries and maintenance Good proficiency using a.o. One or more of the following languages: C, PHP, Perl, Python, Ruby, JavaScript, Java, etc Front-end technologies like Javascript, CSS3 and HTML5 Git Basic understanding of computer security fundamentals and security-minded programming. Basic understanding of (web) user interface design and development. BENEFITS Cool Things You will work in an international start-up company, with a young, dynamic team of 18 people and 10 different nationalities. High responsibility; changes to the website are visible to a global audience. We work in the Netherlands, in Rotterdam, in the picturesque neighborhood Kralingen. Practicalities Full-time position (40 hours a week) Starting: between now and July 2015. Period: we would like to start with a period of 6 months and then we see how and if to continue (Freelance, full time employment, etc). You will work from our office in Rotterdam, the Netherlands. Payment We believe in fair pay that represents your experience. Potential for stock options or a similar construction, in case of outstanding performance. Connect You can connect to us by sending your portfolio to tech@housinganywhere.com. We will be in touch with you within a few days.",
		"FAQ I didn’t get any response when I replied to a room, what’s wrong? Advertisements are posted by students. The advertisers normally pick only one lucky student to sublet their room to, and unfortunately don’t reply to the other people who responded to the room. On average they get 30-40 reactions. If you react to an advertisement, make sure you distinguish yourself from the other 39 people who also react. Don’t simply write “I would like to rent your room”. Take your time to write a nice story about yourself, your hobbys and interests, and your background. This way the advertiser gets to know you better and he or she might select you as their future subtenant. House hunting is a competitive sport! Who posts the advertisements for rooms on HousingAnywhere.com? Students who go on exchange and want to sublet their room (the main tenant) post their rooms on HousingAnywhere.com. Subletting a room means that you or your landlord enter an agreement that a third-party takes over your room and the payment of the rent for a set period of time. Usually the main tenant returns to the room afterwards. Other students, who are looking for accommodation in the city, react to those rooms (the subtenant). The platform is on a student-to-student basis. To advertise a room on this website is free; it is also free to react to the room advertisements. Is there an intermediary involved in the renting process? No, there is no intermediary between the potential landlord and tenant. Students put their room on HousingAnywhere.com, and others can react to those rooms offers. The reaction will be sent directly to the private e-mail address of the person who posted the room to be sublet online. It is on a student-to-student basis, no one will be in between. Is it guaranteed that if I say I am interested that I will get the room? When it comes to renting a room, most housing markets are competitive. On average, we see that each advertiser receives 30 to 40 responses to a listing, indicating that you have a small chance of getting the room. Replying to more listings increases your chances. What if I need legal assistance with rental matters? HousingAnywhere.com only functions as a platform and helps match demand and supply. In case you have a problem with your landlord, sub-tenant, or other renting issues, you can go to an organization which makes sure your rights as a tenant are not violated. How do I know that the advertisement is real, and not a scam? Nothing can be guaranteed. Always ask questions to find out if the room is still available, ask for photos, NEVER pay in full in advance for a room, and always ask if the main tenant has the legal right to sublet the room (ask for written permission from the landlord/owner of the property). We also recommend that you add each other on Facebook, and have some conversations over Skype with each other. Idealis is the student accommodation provider in Wageningen with 4,500 housing units. When you sublet a room from a tenant of Idealis you sign a contract with the tenant. This contract (subletting agreement) gives you the permission to sublet the room. The conditions for subtenancy are on www.idealis.nl Do I have to pay a fee to Housing Anywhere? Housing Anywhere does not charge the main tenant nor the subtenant a fee: using this webpage is free for both parties. I am going to Holland, can you provide me with some more information? In order to combine all the serious issues that you as a student have to deal with, INIQQ can provide you with more informal news. On the website you will find the best of both sides; news about finance (opening a bank account) and such things as finding a tasty cheap beer. You can find more information on www.iniqq.com Do I have to pay a fee to some third party? In the Netherlands you generally do not pay a fee to the landlord, the other tenants, the subtenants, or any other parties. However, when you find a room or apartment through a real estate agent, then you will have to pay this agent/company a commission fee. This fee is normally equal to 1 month rental fee. If I respond to an advertised room, who decides whether I get the room? In the Netherlands, it can be part of the procedure that the other tenants of the flat jointly decide the (sub) tenant. The former tenant puts an advertisement on www.HousingAnywhere.com, you respond by sending an e-mail introducing yourself, and the other tenants select their new housemate based on the information that you e-mailed them. The other tenants might ask you to come over for a social drink so they can get to know you. All the other people who respond to the advertisement are also present at that social drink. These meetings normally last 1-3 hours. The other tenants usually select and inform their new housemate the next day. What do I do next when I find a subtenant? Once the main tenant has chosen a subtenant (and has the approval of their landlord or any other tenants) they should agree in writing on the terms of the subtenancy (duration, rent, how and to whom the rent should be paid, what is in the room, what the subtenant is allowed and not allowed to use etc.). The main tenant should immediately delete the advertisement on www.HousingAnywhere.com using the link they were sent by e-mail. Wageningen specific: If the room is an Idealis room, the main tenant must have permission from Idealis to sublet the room. Tenant and subtenant both fill out the form and the Housing Services Department of Idealis checks it. If everything is in order, Idealis signs the form and the form is then considered to be the subletting agreement. Does HousingAnywhere check the advertisements? No, HousingAnywhere and the participating universities do NOT check the advertisements. Therefore, we advise your to get in touch with each through Skype and add each other on Facebook so you can see if the person you are talking to is a real and trustworthy person. Never pay anything up front! Housing Anywhere and the participating universities are not responsible for any; we only provide you a platform to find each other. How much deposit do I have to pay and to whom? In the Netherlands you might have to pay a security deposit; this is normally 1 to 2 months of the rental fee. You will get this back at the end of your rental period. You pay the deposit to either the landlord or to the real estate company. Always ask for a receipt of your deposit payment. Where can i find legal information regarding subletting laws? We have compiled a list of legal resources for the countries in which we offer our services on the Legal rental information page.",
		"Secure booking service Our secure booking service is an easy, convenient and safe service to make sure you will receive the first month's rent and deposit. For the advertiser this service is for free; the tenant pays a small fee. In short, the advantages: If you rent out a room, you want to make sure that you receive the deposit and the rent in time, without too much hassle. This is what our secure booking service can do for you, for free! Select a tenant After you’ve had some conversations with potential tenants, it’s up to you to pick a tenant to your liking. Click “Accept this tenant” below the conversation in the Dashboard to get the first month rent + (if applicable) the deposit. Get your money within 48 hours After initiating the secure payment, a payment request will be sent to the tenant. The tenant has 48 hours to complete the transfer. We will notify you as soon as the tenant has paid. This way, you are sure the tenant will show up, and thus will not cancel last-minute. We keep your money secure HousingAnywhere keeps the first month rent + deposit on our bank account. Safe and secure. Receive the money when the tenant moves in After the tenant has moved in, the payment will be transfered to your bank account. We transfer the full 100% of the first month rent + deposit to your bank account. We do not ask money from you. Want to know more about our secure booking service? Contact us by clicking the button below.",
		"How to rent a room HousingAnywhere is a platform where the demand and supply of short term accommodation can come together. It is a simple yet effective tool which increases the amount of short term accommodation available to incoming exchange students. Find a room Browse through rooms offered by other students in 500+ cities and 50+ countries Get in touch Contact students that offer a room directly, tell about yourself, ask questions, and become the selected tenant. Make payment Confirm your room booking by paying the first month's rent and deposit through our secured payment system Move in HousingAnywhere.com transfers your rent and deposit to the room advertiser, only after you have moved in and checked the room. Super safe! Find the perfect room in 50+ countries and make sure you have a place to stay before you even land.",
	}
	set := testSet{1000, 5, 3095015, 60, tests}
	startTime := time.Now()
	for i := 0; i < set.numOfTests/set.oneIter; i++ {
		for j := 0; j < set.oneIter; j++ {
			for _, test := range set.tests {
				go SendString(test, finishTestsCount)
				time.Sleep(time.Duration(rand.Intn(10)) * time.Millisecond)
			}
			go GetResult(rand.Intn(10), i*set.oneIter+j, t)
		}
		finish := <-finishTestsCount
		for finish < len(tests)*set.oneIter {
			finish += <-finishTestsCount
		}
	}
	result := GetResult(5, 0, t)
	timeDelta := int(time.Since(startTime) / 1000000000)
	if int(result["count"].(float64)) != set.resultCount {
		t.Errorf("Test result: count expect %d, got %d", set.resultCount, int(result["count"].(float64)))
	}
	if timeDelta > set.runTime {
		t.Errorf("Too slow: runtime expect %d, got %d", set.runTime, timeDelta)
	}

}

func SendString(test string, finishTestsCount chan int) {
	conn, err := net.Dial("tcp", "127.0.0.1:5555")
	for err != nil {
		conn, err = net.Dial("tcp", "127.0.0.1:5555")
	}
	defer conn.Close()
	defer func() { finishTestsCount <- 1 }()
	fmt.Fprintln(conn, test)
	bufio.NewReader(conn).ReadString('\n')

}

func GetResult(N int, i int, t *testing.T) map[string]interface{} {
	request := fmt.Sprintf("http://localhost:8080/?N=%d", N)
	resp, err := http.Get(request)
	if err != nil {
		t.Errorf("Test #%d, N=%d: HTTP connect error: %s", i, N, err)
	}
	defer resp.Body.Close()
	body, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		t.Errorf("Test #%d, N=%d: HTTP read body error: %s", i, N, err)
	}
	mapBody := map[string]interface{}{}
	json.Unmarshal(body, &mapBody)
	return mapBody
}
